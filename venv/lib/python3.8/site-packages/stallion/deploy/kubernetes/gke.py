import logging
import subprocess

from .common import KubernetesDeployer


class GKEDeployerCommon(KubernetesDeployer):
    """ Implements the necessary methods for KubernetesDeployer to attach to a GKE
        cluster.

        This class is still abstract: it does not contain implementation details
        needed to build the deployment spec files.  It is meant to be mixed-in
        with other classes that do provide those details, but that do not provide
        details specific to the type of cluster we're deploying to.
    """
    def build_cluster_name(self, component):
        """ Assemble the local kubectl cluster name for the GKE cluster specified
            by the provided component.

            :param component: the component
            :type component: a subclass of stallion.components.BaseComponent
        """
        return 'gke_{project_id}_{region}_{cluster_name}'.format(
            project_id=self.get_cluster_project_id(component),
            region=component.descriptor['kubernetes']['gke']['cluster_region'],
            cluster_name=component.descriptor['kubernetes']['gke']['cluster_name'])

    def get_cluster_project_id(self, component):
        """ Get the project id for the cluster.  Defaults to the Stallion project
            id if a specific project id is not provided in the component
            descriptor's GKE settings.

            :param component: the component
            :type component: a subclass of stallion.components.BaseComponent
        """
        return component.descriptor['kubernetes']['gke'].get(
            'cluster_project',
            self.project.id)

    def get_cluster_credentials(self, component):
        """ Use gcloud to retrieve credentials for the cluster targeted by the
            provided component.

            :param component: the component
            :type component: a subclass of stallion.components.BaseComponent
        """
        cmd = [
            'gcloud',
            'container',
            'clusters',
            'get-credentials',
            component.descriptor['kubernetes']['gke']['cluster_name'],
            '--project={}'.format(self.get_cluster_project_id(component)),
            '--region={}'.format(component.descriptor['kubernetes']['gke']['cluster_region']),
        ]

        logging.info('Retrieving GKE credentias with call: %s', ' '.join(cmd))

        subprocess.check_call(cmd)
