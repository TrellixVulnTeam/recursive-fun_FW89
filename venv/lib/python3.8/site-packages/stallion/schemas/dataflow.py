import marshmallow as ma
from .base import StrictSchema

ALLOWED_AUTOSCALING_ALGOS = ['THROUGHPUT_BASED', 'NONE']

# label regex patterns given in:
# https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.jobs
LABEL_KEY_PATTERN = '^[a-zA-Z][a-zA-Z0-9_-]{0,62}$'
LABEL_VALUE_PATTERN = '^[a-zA-Z0-9_-]{0,63}$'


class GoogleCloudDataflowSchema(StrictSchema):
    service_account = ma.fields.String()

    region = ma.fields.String(required=True)
    zone = ma.fields.String()

    autoscaling_algorithm = ma.fields.String(
        validate=ma.validate.OneOf(ALLOWED_AUTOSCALING_ALGOS)
    )
    max_num_workers = ma.fields.Integer()
    num_workers = ma.fields.Integer()

    labels = ma.fields.Dict(
        keys=ma.fields.String(
            validate=ma.validate.Regexp(LABEL_KEY_PATTERN),
        ),
        values=ma.fields.String(
            validate=ma.validate.Regexp(LABEL_VALUE_PATTERN),
        )
    )

    use_public_ips = ma.fields.Boolean()
    subnetwork = ma.fields.String()

    job_arguments = ma.fields.List(ma.fields.String())
