import os
import subprocess
import logging
from stallion.components.base import BaseConfigPushHook, BaseCodeDeployComponent

class CronDeployHook(BaseConfigPushHook):
    def run(self, component, deployer, config_manager, dry_run):
        cron_yaml_path = os.path.join(component.config_dir, 'cron.yaml')
        if not os.path.isfile(cron_yaml_path):
            logging.info(
                    'cron.yaml not found at path %s; not deploying GAE cron',
                    cron_yaml_path)
            return

        logging.info('Deploying GAE cron from file %s', cron_yaml_path)

        args = [ 'gcloud', 'app', 'deploy', 'cron.yaml', '--project', deployer.project_id ]
        if dry_run:
            logging.info('  dry run: not executing gcloud command `%s`', ' '.join(args))
            return

        subprocess.check_call(args, cwd=component.config_dir)

class AppEngineBaseApplication(BaseCodeDeployComponent):
    type = 'gae-base-app'
    schema = None
    allowed_deployment_types = frozenset([ 'gae-base-app' ])

    config_push_hooks = [ CronDeployHook() ]
