import marshmallow as ma
from stallion.schemas.base import StrictSchema
from stallion.components.base import BaseCodeDeployComponent


class DataflowJavaComponentSettingsSchema(StrictSchema):
    artifact_bucket = ma.fields.String(required=True)
    artifact_path_template = ma.fields.String(
        required=True,
        validate=ma.validate.Regexp(
            '^.*\{code_version\}.*\.(tgz|tar|tar\.gz)$'
        )
    )
    jar_dir_within_artifact = ma.fields.String()

    main_class = ma.fields.String(required=True)

    code_repo = ma.fields.String(required=True)
    git_tag_name = ma.fields.String(required=True)
    git_tag_version_separator = ma.fields.String(required=True)


class GoogleCloudDataflowJavaStreamingJob(BaseCodeDeployComponent):
    type = 'dataflow-streaming-java'
    schema = None
    allowed_deployment_types = frozenset([ 'dataflow-streaming-java' ])

    settings_schema_cls = DataflowJavaComponentSettingsSchema

    @property
    def code_repo(self):
        return self.settings['code_repo']

    @property
    def git_tag_name(self):
        return self.settings['git_tag_name']

    @property
    def git_tag_version_separator(self):
        return self.settings['git_tag_version_separator']
