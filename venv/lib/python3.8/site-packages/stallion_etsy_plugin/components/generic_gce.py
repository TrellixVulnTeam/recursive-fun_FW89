import marshmallow as ma
from stallion.schemas.base import StrictSchema
from stallion.components.base import BaseCodeDeployComponent
from stallion_etsy_plugin.components.base import BaseServiceSchema


class GenericGCEServiceSettingsSchema(StrictSchema):
    image_uri_base = ma.fields.String(required=True)

    code_repo = ma.fields.String(required=True)
    git_tag_name = ma.fields.String(required=True)
    git_tag_version_separator = ma.fields.String(required=True)


class GenericGCEService(BaseCodeDeployComponent):
    type = 'generic-gce-service'
    allowed_deployment_types = frozenset([ 'gce' ])
    schema = None

    settings_schema_cls = GenericGCEServiceSettingsSchema

    @property
    def code_repo(self):
        return self.settings['code_repo']

    @property
    def git_tag_name(self):
        return self.settings['git_tag_name']

    @property
    def git_tag_version_separator(self):
        return self.settings['git_tag_version_separator']

    def build_image_url(self):
        return '{base}:{version}'.format(
            base=self.settings['image_uri_base'],
            version=self.code_version)


class GenericAuthedGCEService(GenericGCEService):
    type = 'generic-authed-gce-service'
    schema = BaseServiceSchema

    deploy_files = ['proxy_config.yaml']
