from __future__ import print_function
import pkg_resources
from stallion.release_process import ReleaseProcessor

def check_versions(allow_ahead=False):
    print('Checking for updates...')

    _require_latest_package(
        package_name='workflow_templates',
        repo_owner='Engineering',
        repo='BigData',
        tag_name='workflow-templates',
        tag_separator='@',
        is_dependency=False,
        allow_ahead=allow_ahead)

    _require_latest_package(
        package_name='etsy_dataproc_common_config',
        repo_owner='Engineering',
        repo='BigData',
        tag_name='etsy-dataproc-common-config',
        tag_separator='@',
        is_dependency=True,
        allow_ahead=allow_ahead)

def _require_latest_package(
        package_name,
        repo_owner,
        repo,
        tag_name,
        tag_separator,
        is_dependency,
        allow_ahead):
    my_version = pkg_resources.get_distribution(package_name).version
    latest_version = ReleaseProcessor.get_git_tag_version(
            code_repo_owner=repo_owner,
            code_repo=repo,
            tag_name=tag_name,
            tag_separator=tag_separator)[0]

    if pkg_resources.parse_version(my_version) < pkg_resources.parse_version(latest_version):
        raise Exception('''
        A new version ({}) of {} is available!
        (your version is {}).  Please refresh your workflow-templates installation
        using "pip install --upgrade --upgrade-strategy=eager workflow-templates" and submit your job again.
        If you have issues, please see installation instructions at:
        https://github.etsycorp.com/Engineering/BigData/tree/master/gcp/dataproc-workflows
        '''.format(
            latest_version,
            package_name if not is_dependency else 'the workflow-templates dependency package `{}`'.format(package_name),
            my_version).strip())

    if allow_ahead:
        return

    if pkg_resources.parse_version(my_version) > pkg_resources.parse_version(latest_version):
        raise Exception('''
        You are using an unpublished version ({}) of {} latest is ({})!
        If you are sure that this is what you want to be doing (eg if you are
        testing a development version of the runner scripts), then please
        pass the --dev flag to the script and try again.  Otherwise, please
        pip-install the latest version and submit your job again. For
        installation instructions, see:
        https://github.etsycorp.com/Engineering/BigData/tree/master/gcp/dataproc-workflows
        '''.format(
            my_version,
            package_name if not is_dependency else 'the workflow-templates dependency package `{}`'.format(package_name),
            latest_version).strip())
